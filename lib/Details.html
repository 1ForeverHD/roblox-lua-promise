<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementation Details | Roblox Lua Promise</title>
    <meta name="description" content="Promise implementation for Roblox">
    
    
    <link rel="preload" href="/roblox-lua-promise/assets/css/0.styles.d877d60a.css" as="style"><link rel="preload" href="/roblox-lua-promise/assets/js/app.9c55d8b7.js" as="script"><link rel="preload" href="/roblox-lua-promise/assets/js/6.27a40301.js" as="script"><link rel="preload" href="/roblox-lua-promise/assets/js/12.e9c1eb89.js" as="script"><link rel="prefetch" href="/roblox-lua-promise/assets/js/1.6cd63ced.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/10.0a086da3.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/11.ab9db194.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/13.2fb570c3.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/14.4d62b16e.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/15.9e83e02e.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/16.be658657.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/17.bb8d6bef.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/18.61e0d96a.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/19.87476339.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/2.47a83fe0.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/20.b789e9a2.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/21.750430af.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/22.89f2c322.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/3.72cb5171.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/5.3082b837.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/7.9b6f8f5c.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/8.30d1d3de.js"><link rel="prefetch" href="/roblox-lua-promise/assets/js/9.1a586211.js">
    <link rel="stylesheet" href="/roblox-lua-promise/assets/css/0.styles.d877d60a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/roblox-lua-promise/" class="home-link router-link-active"><!----> <span class="site-name">Roblox Lua Promise</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/roblox-lua-promise/lib/" class="nav-link router-link-active">API Reference</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/roblox-lua-promise/lib/" class="nav-link router-link-active">API Reference</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/roblox-lua-promise/lib/" class="sidebar-link">Promise</a></li><li><a href="/roblox-lua-promise/lib/Details.html" class="active sidebar-link">Implementation Details</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/roblox-lua-promise/lib/Details.html#yielding-in-promise-executor" class="sidebar-link">Yielding in Promise executor</a></li><li class="sidebar-sub-header"><a href="/roblox-lua-promise/lib/Details.html#cancellation-details" class="sidebar-link">Cancellation details</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/roblox-lua-promise/lib/Details.html#cancellation-propagation" class="sidebar-link">Cancellation propagation</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="implementation-details"><a href="#implementation-details" aria-hidden="true" class="header-anchor">#</a> Implementation Details</h1> <h2 id="yielding-in-promise-executor"><a href="#yielding-in-promise-executor" aria-hidden="true" class="header-anchor">#</a> Yielding in Promise executor</h2> <p>If you need to yield in the Promise executor, you must wrap your yielding code in a new thread to prevent your calling thread from yielding. The easiest way to do this is to wrap your code with the built-in <code>Promise.spawn</code>:</p> <div class="language-lua extra-class"><pre class="language-lua"><code>Promise<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
  Promise<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre></div><p><code>Promise.spawn</code> uses a BindableEvent internally to launch your Promise body on a fresh thread after waiting for the next <code>RunService.Heartbeat</code> event.</p> <p>The reason <code>Promise.spawn</code> includes this wait time is to ensure that your Promises have consistent timing. Otherwise, your Promise would run synchronously up to the first yield, and asynchronously afterwards. This can often lead to undesirable results. Additionally, Promises that never yield can resolve completely synchronously, and this can lead to unpredictable timing issues. Thus, we use <code>Promise.spawn</code> so there is always a guaranteed yield before execution.</p> <div class="danger custom-block"><p class="custom-block-title">Don't use regular spawn</p> <p><code>spawn</code> might seem like a tempting alternative to <code>Promise.spawn</code> here, but you should <strong>never</strong> use it!</p> <p><code>spawn</code> (and <code>wait</code>, for that matter) do not resume threads at a consistent interval. If Roblox has resumed too many threads in a single Lua step, it will begin throttling and your thread that was meant to be resumed on the next frame could actually be resumed several seconds later. The unexpected delay caused by this behavior will cause cascading timing issues in your game and could lead to some potentially ugly bugs.</p></div> <div class="warning custom-block"><p class="custom-block-title">coroutine.wrap would work, but...</p> <p><code>coroutine.wrap</code> is another possible stand-in for creating a BindableEvent and firing it off, but in the case of an error, the stack trace is reset when the coroutine executes. This can make troubleshooting extremely difficult because you don't know where to look in your code base for the source of the error. Creating a BindableEvent is relatively cheap, so you shouldn't need to worry about this causing performance problems in your game.</p></div> <h2 id="cancellation-details"><a href="#cancellation-details" aria-hidden="true" class="header-anchor">#</a> Cancellation details</h2> <p>If a Promise is already cancelled at the time of calling its onCancel hook, the hook will be called immediately.</p> <p>If you attach a <code>:andThen</code> or <code>:catch</code> handler to a Promise after it's been cancelled, the chained Promise will be instantly rejected with the error &quot;Promise is cancelled&quot;.</p> <p>If you cancel a Promise immediately after creating it in the same Lua cycle, the fate of the Promise is dependent on if the Promise handler yields or not. If the Promise handler resolves without yielding, then the Promise will already be settled by the time you are able to cancel it, thus any consumers of the Promise will have already been called.</p> <p>If the Promise does yield, then cancelling it immediately <em>will</em> prevent its resolution. This is always the case when using <code>Promise.spawn</code>.</p> <p>Attempting to cancel an already-settled Promise is ignored.</p> <h3 id="cancellation-propagation"><a href="#cancellation-propagation" aria-hidden="true" class="header-anchor">#</a> Cancellation propagation</h3> <p>When you cancel a Promise, the cancellation propagates up the Promise chain. Promises keep track of the number of consumers that they have, and when the upwards propagation encounters a Promise that no longer has any consumers, that Promise is cancelled as well.</p> <p>It's important to note that cancellation does <strong>not</strong> propagate downstream, so if you get a handle to a Promise earlier in the chain and cancel it directly, Promises that are consuming the cancelled Promise will remain in an unsettled state forever.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê
        <a href="/roblox-lua-promise/lib/" class="prev router-link-active">
          Promise
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/roblox-lua-promise/assets/js/app.9c55d8b7.js" defer></script><script src="/roblox-lua-promise/assets/js/6.27a40301.js" defer></script><script src="/roblox-lua-promise/assets/js/12.e9c1eb89.js" defer></script>
  </body>
</html>
